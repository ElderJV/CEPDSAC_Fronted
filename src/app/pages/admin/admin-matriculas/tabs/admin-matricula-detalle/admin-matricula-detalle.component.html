<div class="admin-container">
  @if (loading()) {
  <div class="text-center mt-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  }

  @if (!loading()) {
  @if (detalle(); as d) {
  <div class="header-section">
    <div class="d-flex justify-content-between align-items-center">
      <h2>
        <lucide-icon [img]="FileText" class="me-2"></lucide-icon>
        Detalle de Matrícula #{{ d.idMatricula }}
      </h2>
      <div class="d-flex gap-2">
        @if (d.estado !== 'CANCELADO') {
        <button class="btn btn-outline-danger d-flex align-items-center gap-2" (click)="cancelarMatricula()">
          <lucide-icon [img]="CircleX" size="18"></lucide-icon>
          Cancelar Matrícula
        </button>
        }
        <button class="btn btn-outline-secondary d-flex align-items-center gap-2" [routerLink]="['/admin/matriculas']">
          <lucide-icon [img]="ArrowLeft" size="18"></lucide-icon>
          Volver
        </button>
      </div>
    </div>
  </div>

  <div class="alert-custom mb-4">
    <div class="alert-icon">
      @if (d.estado === 'CONFIRMADO' || d.estado === 'PAGADO') {
      <lucide-icon [img]="CheckCircle"></lucide-icon>
      } @else if (d.estado === 'CANCELADO') {
      <lucide-icon [img]="CircleX"></lucide-icon>
      } @else {
      <lucide-icon [img]="AlertCircle"></lucide-icon>
      }
    </div>
    <div class="alert-content d-flex justify-content-between align-items-center">
      <div>
        <strong>Estado:</strong>
        <span class="badge ms-2" [ngClass]="getEstadoBadgeClass(d.estado)">
          {{ d.estado }}
        </span>
      </div>
      <small class="text-muted">
        Fecha de matrícula: {{ d.fechaMatricula | date: 'dd/MM/yyyy HH:mm' }}
      </small>
    </div>
  </div>

  <div class="row mb-4 g-3">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-icon bg-primary-subtle text-primary">
          <lucide-icon [img]="DollarSign"></lucide-icon>
        </div>
        <div class="stat-content">
          <h6 class="stat-label">Monto Total</h6>
          <h3 class="stat-value text-primary">S/. {{ d.monto | number: '1.2-2' }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-icon bg-success-subtle text-success">
          <lucide-icon [img]="CheckCircle"></lucide-icon>
        </div>
        <div class="stat-content">
          <h6 class="stat-label">Total Pagado</h6>
          <h3 class="stat-value text-success">S/. {{ getTotalPagado() | number: '1.2-2' }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-icon bg-warning-subtle text-info">
          <lucide-icon [img]="Hourglass"></lucide-icon>
        </div>
        <div class="stat-content">
          <h6 class="stat-label">Saldo Pendiente</h6>
          <h3 class="stat-value text-info">S/. {{ getSaldoPendiente() | number: '1.2-2' }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-icon bg-secondary-subtle text-muted">
          <lucide-icon [img]="PieChart"></lucide-icon>
        </div>
        <div class="stat-content">
          <h6 class="stat-label">Cuotas</h6>
          <h3 class="stat-value text-dark">{{ getCuotasPagadas() }} / {{ d.pagos.length }}</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-header bg-white border-bottom-0 pt-4 ps-4">
          <h5 class="card-title text-primary fw-bold mb-0 d-flex align-items-center gap-2">
            <lucide-icon [img]="User"></lucide-icon>
            Información del Alumno
          </h5>
        </div>
        <div class="card-body">
          <p><strong>Nombre:</strong> {{ d.alumno.nombre }} {{ d.alumno.apellido }}</p>
          <p><strong>{{ d.alumno.inicialesTipoIdentificacion }}:</strong> {{ d.alumno.numeroIdentificacion }}</p>
          <p><strong>Correo:</strong> {{ d.alumno.correo }}</p>
          <p><strong>Rol: </strong> <span class="badge bg-secondary">{{ d.alumno.rol }}</span></p>
          <p><strong>Estado: </strong>
            <span class="badge" [class.bg-success]="d.alumno.activo" [class.bg-danger]="!d.alumno.activo">
              {{ d.alumno.activo ? 'ACTIVO' : 'INACTIVO' }}
            </span>
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-header bg-white border-bottom-0 pt-4 ps-4">
          <h5 class="card-title text-info fw-bold mb-0 d-flex align-items-center gap-2">
            <lucide-icon [img]="Book"></lucide-icon>
            Información del Curso
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex gap-3">
            @if (d.cursoDiplomado.urlCurso) {
            <img [src]="d.cursoDiplomado.urlCurso" alt="Curso" class="img-thumbnail border-0 shadow-sm rounded-3"
              style="width: 100px; height: 100px; object-fit: cover;">
            }
            <div class="flex-grow-1">
              <h5 class="card-title text-dark fw-bold">{{ d.cursoDiplomado.titulo }}</h5>
              <p class="mb-2"><span class="badge bg-secondary">{{ d.cursoDiplomado.nombreCategoria }}</span> <span
                  class="badge bg-info text-white ms-1">{{ d.cursoDiplomado.tipo }}</span></p>
              <p class="mb-2 text-muted small" title="{{ d.cursoDiplomado.objetivo }}">
                {{ d.cursoDiplomado.objetivo | slice:0:150 }}{{ d.cursoDiplomado.objetivo.length > 150 ? '...' : '' }}
              </p>
              <p class="mb-1"><strong>Precio Base:</strong> S/. {{ d.montoBase | number: '1.2-2' }}</p>
              @if (d.cursoDiplomado.otorgaCertificado) {
              <span class="badge bg-success mt-1 d-inline-flex align-items-center gap-1">
                <lucide-icon [img]="Award" size="14"></lucide-icon> Certificado
              </span>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  @if (d.descuento) {
  <div class="alert-custom mb-4">
    <div class="alert-icon">
      <lucide-icon [img]="Tag"></lucide-icon>
    </div>
    <div class="alert-content d-flex justify-content-between align-items-center">
      <div>
        <strong>Descuento Aplicado:</strong> {{ d.descuento.tipoDescuento }}
        ({{ d.descuento.valor | number: '1.2-2' }} {{ d.descuento.tipoDescuento === 'PORCENTAJE' ? '%' : 'S/.' }})
        - Monto descontado: S/. {{ d.montoDescontado | number: '1.2-2' }}
      </div>
      <small>Vigencia: {{ d.descuento.fechaInicio | date:'dd/MM/yyyy' }} - {{ d.descuento.fechaFin | date:'dd/MM/yyyy'
        }}</small>
    </div>
  </div>
  } @else {
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body bg-light">
      <h6 class="card-title text-secondary"><i class="bi bi-tag me-2"></i>Aplicar Descuento</h6>
      <div class="d-flex gap-2">
        <select class="form-select" [ngModel]="descuentoSeleccionado()"
          (ngModelChange)="descuentoSeleccionado.set($event)">
          <option [ngValue]="null">Seleccione un descuento...</option>
          @for (desc of descuentos(); track desc.idDescuento) {
          <option [ngValue]="desc.idDescuento">
            {{ desc.tipoDescuento }} - {{ desc.valor }} {{ desc.tipoDescuento === 'PORCENTAJE' ? '%' : 'S/.' }}
          </option>
          }
        </select>
        <button class="btn btn-primary" (click)="aplicarDescuento()" [disabled]="!descuentoSeleccionado()">
          Aplicar
        </button>
      </div>
    </div>
  </div>
  }

  <div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white border-bottom pt-4 ps-4 pb-3">
      <h5 class="card-title text-secondary fw-bold mb-0">
        <i class="bi bi-cash-stack me-2"></i>
        Cuotas de Pago
      </h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Cuota</th>
              <th>Monto</th>
              <th>Vencimiento</th>
              <th>Estado</th>
              <th>Fecha Pago</th>
              <th>Método</th>
              <th>Operación</th>
            </tr>
          </thead>
          <tbody>
            @for (pago of d.pagos; track pago.idPago) {
            <tr [class.table-danger]="pago.estadoCuota === 'VENCIDA'"
              [class.table-success]="pago.estadoCuota === 'PAGADO'">
              <td class="fw-bold text-secondary">#{{ pago.numeroCuota }}</td>
              <td class="fw-bold">S/. {{ pago.monto | number: '1.2-2' }}</td>
              <td>
                @if (pago.fechaVencimiento) {
                {{ pago.fechaVencimiento | date: 'dd/MM/yyyy' }}
                @if (estaVencida(pago.fechaVencimiento) && pago.estadoCuota === 'PENDIENTE') {
                <i class="bi bi-exclamation-triangle text-danger ms-1"></i>
                }
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
              <td>
                <span class="badge" [ngClass]="getCuotaBadgeClass(pago.estadoCuota)">
                  {{ pago.estadoCuota }}
                </span>
              </td>
              <td>
                @if (pago.fechaPago) {
                <span class="text-success"><i class="bi bi-check-circle me-1"></i>{{ pago.fechaPago | date: 'dd/MM/yyyy
                  HH:mm' }}</span>
                } @else {
                <span class="text-muted fst-italic">Sin pagar</span>
                }
              </td>
              <td>
                @if (pago.metodoPagoDescripcion) {
                {{ pago.metodoPagoDescripcion }}
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
              <td>
                @if (pago.numeroOperacion) {
                <span class="text-dark small">{{ pago.numeroOperacion }}</span>
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="payment-form" class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom pt-4 ps-4 pb-3">
      <h5 class="card-title text-success fw-bold mb-0">
        <i class="bi bi-plus-circle me-2"></i>
        Registrar Nuevo Pago
      </h5>
    </div>
    <div class="card-body">
      <form [formGroup]="pagoForm" (ngSubmit)="registrarPago()">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="metodoPago" class="form-label">Método de Pago *</label>
            <select id="metodoPago" class="form-select" formControlName="idMetodoPago"
              [class.is-invalid]="pagoForm.get('idMetodoPago')?.invalid && pagoForm.get('idMetodoPago')?.touched">
              @for (metodo of metodosPago(); track metodo.idMetodoPago) {
              <option [value]="metodo.idMetodoPago">
                {{ metodo.descripcion }} ({{ metodo.tipoMetodo }})
              </option>
              }
            </select>
            @if (pagoForm.get('idMetodoPago')?.invalid && pagoForm.get('idMetodoPago')?.touched) {
            <div class="invalid-feedback">
              Selecciona un método de pago
            </div>
            }
          </div>

          @if (d.pagos.length === 0) {
          <div class="col-md-6 mb-3">
            <label for="monto" class="form-label">
              Monto (Opcional)
              <small class="text-muted">Si no se especifica, se usará el monto de la cuota pendiente</small>
            </label>
            <input type="number" id="monto" class="form-control" formControlName="monto" step="0.01" min="0.01"
              placeholder="Ej: 100.00"
              [class.is-invalid]="pagoForm.get('monto')?.invalid && pagoForm.get('monto')?.touched">
            @if (pagoForm.get('monto')?.invalid && pagoForm.get('monto')?.touched) {
            <div class="invalid-feedback">
              El monto debe ser mayor a 0
            </div>
            }
          </div>
          }
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="numeroOperacion" class="form-label">Número de Operación / Referencia</label>
            <input type="text" id="numeroOperacion" class="form-control" formControlName="numeroOperacion"
              placeholder="Ej: 12345678">
          </div>

          <div class="col-md-6 mb-3">
            <label for="fechaPago" class="form-label">Fecha de Pago</label>
            <input type="datetime-local" id="fechaPago" class="form-control" formControlName="fechaPago">
          </div>

          <div class="col-12 mb-3">
            <label for="observaciones" class="form-label">Observaciones</label>
            <textarea id="observaciones" class="form-control" formControlName="observaciones" rows="2"
              placeholder="Notas adicionales sobre el pago..."></textarea>
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-success px-4 py-2" [disabled]="pagoForm.invalid || submitting()">
            @if (submitting()) {
            <span class="spinner-border spinner-border-sm me-2"></span>
            }
            <i class="bi bi-check-circle me-1"></i>
            Registrar Pago
          </button>
        </div>
      </form>
    </div>
  </div>
  }
  }
</div>